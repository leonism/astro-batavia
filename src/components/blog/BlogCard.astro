---
import type { CollectionEntry } from 'astro:content';
import type { LanguageKey } from '@/i18n/types';
import Picture from '@/components/ui/Picture.astro';
import { BlogCardService } from '@/services/BlogCardService';

export interface Props {
  post: CollectionEntry<'blog'>;
  lang: LanguageKey;
  showExcerpt?: boolean;
  isFeatured?: boolean;
  /**
   * Controls the image loading strategy.
   * 'eager': Load immediately (use for above-the-fold content).
   * 'lazy': Load when near viewport (use for below-the-fold content).
   * Defaults to 'eager' if isFeatured is true, otherwise 'lazy'.
   */
  loading?: 'eager' | 'lazy';
}

const vm = BlogCardService.getViewModel(Astro.props);
---

<article class={vm.cssClasses.article} aria-labelledby={`blog-post-title-${vm.id}`}>
  {
    vm.heroImage && (
      <div class={vm.cssClasses.imageContainer}>
        <a href={vm.postUrl} tabindex="-1" aria-hidden="true">
          <Picture
            src={vm.heroImage.src}
            alt={vm.heroImage.alt}
            width={600}
            height={400}
            class={vm.cssClasses.image}
            loading={vm.imageLoading}
            decoding={vm.imageDecoding}
          />
        </a>
      </div>
    )
  }

  <div class={vm.cssClasses.content}>
    {
      vm.tags.length > 0 && (
        <div
          class={`mb-3 flex flex-wrap gap-2 ${Astro.props.isFeatured ? 'md:mb-4' : ''}`}
          role="group"
          aria-label="Post tags"
        >
          {vm.tags.map((tag) => (
            <a
              href={tag.url}
              class="inline-flex items-center rounded-full bg-primary-100 px-2.5 py-0.5 text-xs font-medium text-primary-800 transition-colors duration-200 hover:bg-primary-200 dark:bg-primary-900 dark:text-primary-200 dark:hover:bg-primary-800"
            >
              #{tag.name}
            </a>
          ))}
          {vm.remainingTagsCount > 0 && (
            <span class="inline-flex items-center rounded-full bg-gray-100 px-2.5 py-0.5 text-xs font-medium text-gray-600 dark:bg-gray-700 dark:text-gray-300">
              +{vm.remainingTagsCount}
            </span>
          )}
        </div>
      )
    }

    <h2 class={vm.cssClasses.title} id={`blog-post-title-${vm.id}`}>
      <a href={vm.postUrl}>
        {vm.title}
      </a>
    </h2>

    {vm.excerpt && <p class={vm.cssClasses.excerpt}>{vm.excerpt}</p>}

    <div class="mt-auto pt-4">
      <div class="flex items-center justify-between text-sm text-gray-500 dark:text-gray-400">
        <div class="flex items-center space-x-3">
          <div class="flex items-center">
            <svg
              class="mr-1 h-4 w-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              aria-hidden="true"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
              >
              </path>
            </svg>
            <span>{vm.author}</span>
          </div>

          <time datetime={vm.isoDate} class="flex items-center">
            <svg
              class="mr-1 h-4 w-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              aria-hidden="true"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
              >
              </path>
            </svg>
            {vm.pubDate}
          </time>
        </div>

        {
          vm.readingTime && (
            <div class="flex items-center">
              <svg
                class="mr-1 h-4 w-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                aria-hidden="true"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
              <span>{vm.readingTime}</span>
            </div>
          )
        }
      </div>

      <div class="mt-4">
        <a
          href={vm.postUrl}
          class="group inline-flex items-center justify-center rounded-lg bg-primary-600 px-4 py-2 text-sm font-medium text-white transition-all duration-200 hover:scale-105 hover:bg-primary-700 hover:shadow-lg dark:bg-primary-500 dark:hover:bg-primary-600"
          aria-label={vm.translations.readMoreAbout}
        >
          {vm.translations.readMore}
          <svg
            class="ml-2 h-4 w-4 transition-transform duration-200 group-hover:translate-x-1"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            aria-hidden="true"
          >
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7">
            </path>
          </svg>
        </a>
      </div>
    </div>
  </div>
</article>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .line-clamp-4 {
    display: -webkit-box;
    -webkit-line-clamp: 4;
    line-clamp: 4;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
