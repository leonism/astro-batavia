---
import { ViewTransitions } from 'astro:transitions';
import SEO from './SEO.astro';
import Schema from './Schema.astro';
import ThemeInitializer from '@/components/common/ThemeInitializer.astro';
import { GoogleTagmanager } from '@digi4care/astro-google-tagmanager';
import { SITE_METADATA, SITE_AUTHOR } from '@/consts';

interface Props {
  title?: string;
  description?: string;
  image?: string;
  articleDate?: string | Date;
  type?: 'website' | 'article';
  lang?: string;
  author?: string;
  authorUrl?: string;
  imageAlt?: string;
  tags?: string[];
  canonical?: string;
  publishedTime?: string;
  modifiedTime?: string;
  readingTime?: number;
  wordCount?: number;
  excerpt?: string;
  breadcrumbs?: Array<{ name: string; url: string }>;
  organization?: any;
  faqs?: Array<{ question: string; answer: string }>;
  review?: any;
  license?: string;
  acquireLicensePage?: string;
  creditText?: string;
  copyrightNotice?: string;
  creator?: string;
}

const {
  title: pageTitle,
  description: pageDescription,
  image,
  articleDate,
  type = 'website',
  lang = SITE_METADATA.defaultLanguage,
  author,
  authorUrl,
  imageAlt,
  tags,
  canonical,
  publishedTime,
  modifiedTime,
  readingTime,
  wordCount,
  excerpt,
  breadcrumbs,
  organization,
  faqs,
  review,
  license,
  acquireLicensePage,
  creditText,
  copyrightNotice,
  creator,
} = Astro.props;

// Get GTM_ID from environment variables
const gtmId = import.meta.env.GTM_ID;

const siteTitle = SITE_METADATA.title;
const siteDescription = SITE_METADATA.description;
const siteUrl = SITE_METADATA.siteUrl;

const fullTitle = pageTitle ? `${pageTitle} | ${siteTitle}` : siteTitle;
const finalDescription = pageDescription || siteDescription;
const finalImageUrl = image
  ? new URL(image, siteUrl).href
  : new URL('/og-default.png', siteUrl).href;
const finalCanonicalUrl = canonical || new URL(Astro.url.pathname, siteUrl).href;

---

<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="generator" content={Astro.generator} />
<link rel="sitemap" href="/sitemap-0.xml" />
{gtmId && <GoogleTagmanager id={gtmId} />}

<title>{fullTitle}</title>
<meta name="description" content={finalDescription} />
<meta name="author" content={author || SITE_AUTHOR.name} />

{publishedTime && <meta property="article:published_time" content={publishedTime} />}
{modifiedTime && <meta property="article:modified_time" content={modifiedTime} />}

<SEO
  title={pageTitle}
  description={pageDescription}
  image={finalImageUrl}
  canonical={finalCanonicalUrl}
  type={type}
  lang={lang}
  publishedTime={publishedTime || (articleDate ? new Date(articleDate).toISOString() : undefined)}
  modifiedTime={modifiedTime}
  author={author}
  authorUrl={authorUrl}
  tags={tags}
  readingTime={readingTime?.toString()}
  wordCount={wordCount}
  excerpt={excerpt}
  breadcrumbs={breadcrumbs}
  organization={organization}
/>

<Schema
  title={title}
  description={description}
  date={articleDate}
  image={finalImageUrl}
  imageAlt={imageAlt}
  type={type}
  author={author}
  authorUrl={authorUrl}
  modifiedTime={modifiedTime}
  breadcrumbs={breadcrumbs}
  faqs={faqs}
  review={review}
  license={license}
  acquireLicensePage={acquireLicensePage}
  creditText={creditText}
  copyrightNotice={copyrightNotice}
  creator={creator}
/>

<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link
  href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap"
  rel="stylesheet"
/>

<ThemeInitializer />
<ViewTransitions />
