---
import { imageSize } from 'image-size';
import path from 'path';
import fs from 'fs';
import { SITE_TITLE, SITE_URL, SITE_AUTHOR } from '@/consts';

export interface Props {
  title: string;
  description: string;
  date?: string | Date;
  image?: string;
  imageAlt?: string;
  type?: 'website' | 'article' | 'blog' | 'collection';
  author?: string;
  authorUrl?: string;
  modifiedTime?: string | Date;
  collectionPosts?: Array<{
    title: string;
    url: string;
    description?: string;
    date?: string | Date;
  }>;
  breadcrumbs?: { name: string; url: string }[];
  faqs?: { question: string; answer: string }[];
  review?: {
    itemReviewed?: {
      name: string;
      image?: string;
      description?: string;
    };
    author?: string;
    ratingValue?: number;
    bestRating?: number;
    worstRating?: number;
    reviewBody?: string;
    datePublished?: string | Date;
  };
  license?: string;
  acquireLicensePage?: string;
  creditText?: string;
  copyrightNotice?: string;
  creator?: string;
  canonical?: string;
  organization?: {
    name: string;
    url: string;
    logo: string;
    sameAs?: string[];
  };
}

const {
  title,
  description,
  date,
  image,
  imageAlt,
  type = 'website',
  author = SITE_AUTHOR.name,
  authorUrl,
  modifiedTime,
  collectionPosts,
  breadcrumbs,
  faqs,
  review,
  license,
  acquireLicensePage,
  creditText,
  copyrightNotice,
  creator,
  canonical,
  organization,
} = Astro.props;

const siteUrl = (Astro.site ? Astro.site.href : SITE_URL).replace(/\/$/, '');
const canonicalUrl = canonical || new URL(Astro.url.pathname, siteUrl).href;
const imageUrl = image ? new URL(image, siteUrl).href : new URL('/favicon-32x32.png', siteUrl).href;

let imageDimensions = null;
if (image) {
  const imagePath = path.join(process.cwd(), 'public', image);
  if (fs.existsSync(imagePath)) {
    try {
      imageDimensions = imageSize(fs.readFileSync(imagePath));
    } catch (e) {
      console.error(`Error getting image dimensions for ${imagePath}:`, e);
    }
  }
}

const graph: Record<string, any>[] = [];

let imageSchema: Record<string, any> = {
  '@type': 'ImageObject',
  url: imageUrl,
  contentUrl: imageUrl,
  caption: imageAlt || title,
  representativeOfPage: true,
};

if (imageDimensions) {
  imageSchema.width = imageDimensions.width;
  imageSchema.height = imageDimensions.height;
}

if (license) imageSchema.license = license;
if (acquireLicensePage) imageSchema.acquireLicensePage = acquireLicensePage;
if (creditText) imageSchema.creditText = creditText;
if (copyrightNotice) imageSchema.copyrightNotice = copyrightNotice;
if (creator) {
  imageSchema.creator = {
    '@type': 'Person',
    name: creator,
  };
}

if (type === 'article' || type === 'blog') {
  graph.push({
    '@type': 'BlogPosting',
    headline: title,
    description: description,
    url: canonicalUrl,
    image: imageSchema,
    datePublished: date ? new Date(date).toISOString() : new Date().toISOString(),
    dateModified: modifiedTime
      ? new Date(modifiedTime).toISOString()
      : date
        ? new Date(date).toISOString()
        : new Date().toISOString(),
    author: {
      '@type': 'Person',
      name: author,
      ...(authorUrl && { url: authorUrl }),
    },
    publisher: organization
      ? {
          '@type': 'Organization',
          name: organization.name,
          url: organization.url,
          logo: {
            '@type': 'ImageObject',
            url: organization.logo,
          },
          ...(organization.sameAs && { sameAs: organization.sameAs }),
        }
      : {
          '@type': 'Organization',
          name: SITE_TITLE,
          url: siteUrl,
          logo: {
            '@type': 'ImageObject',
            url: new URL('/favicon.svg', siteUrl).href,
          },
        },
    mainEntityOfPage: {
      '@type': 'WebPage',
      '@id': canonicalUrl,
    },
  });
} else if (type === 'collection') {
  graph.push({
    '@type': 'CollectionPage',
    '@id': canonicalUrl,
    url: canonicalUrl,
    name: title,
    description: description,
    isPartOf: {
      '@type': 'WebSite',
      '@id': siteUrl,
      name: SITE_TITLE,
      url: siteUrl,
    },
    hasPart: collectionPosts?.map((post) => ({
      '@type': 'BlogPosting',
      headline: post.title,
      url: post.url.startsWith('http') ? post.url : new URL(post.url, siteUrl).href,
      description: post.description,
      datePublished: post.date ? new Date(post.date).toISOString() : undefined,
    })),
  });
} else {
  graph.push({
    '@type': 'WebSite',
    name: title,
    description: description,
    url: siteUrl,
    potentialAction: {
      '@type': 'SearchAction',
      target: `${siteUrl}/search?q={search_term_string}`,
      'query-input': 'required name=search_term_string',
    },
  });
}

if (breadcrumbs && breadcrumbs.length > 0) {
  graph.push({
    '@type': 'BreadcrumbList',
    itemListElement: breadcrumbs.map((crumb, index) => ({
      '@type': 'ListItem',
      position: index + 1,
      name: crumb.name,
      item: crumb.url,
    })),
  });
}

if (faqs && faqs.length > 0) {
  graph.push({
    '@type': 'FAQPage',
    mainEntity: faqs.map((faq) => ({
      '@type': 'Question',
      name: faq.question,
      acceptedAnswer: {
        '@type': 'Answer',
        text: faq.answer,
      },
    })),
  });
}

if (review) {
  graph.push({
    '@type': 'Review',
    itemReviewed: {
      '@type': 'Thing',
      name: review.itemReviewed?.name || title,
      description: review.itemReviewed?.description,
      image: review.itemReviewed?.image
        ? new URL(review.itemReviewed.image, siteUrl).href
        : undefined,
    },
    author: {
      '@type': 'Person',
      name: review.author || author,
    },
    reviewRating: {
      '@type': 'Rating',
      ratingValue: review.ratingValue,
      bestRating: review.bestRating || 5,
      worstRating: review.worstRating || 1,
    },
    datePublished: review.datePublished
      ? new Date(review.datePublished).toISOString()
      : new Date().toISOString(),
    reviewBody: review.reviewBody,
  });
}

const schema = {
  '@context': 'https://schema.org',
  '@graph': graph,
};
---

<script
  type="application/ld+json"
  set:html={JSON.stringify(schema)}
/>
