---
import { SITE_TITLE, SITE_URL } from '@/consts';
import type { CollectionEntry } from 'astro:content';
import Layout from './Layout.astro';
import BlogNextPrevNavigation from '@/components/blog/BlogPrevNextNavigation.astro';
import BlogShareButtons from '@/components/blog/BlogShareButtons.astro';
import { getLangFromUrl, useTranslations, getLocalizedPath } from '@/i18n/utils';
import BlogRelatedArticles from '@/components/blog/BlogRelatedArticles.astro';
import BlogTableOfContents from '@/components/blog/BlogTableOfContents.astro';
import BlogPostMeta from '@/components/blog/BlogPostMeta.astro';
import BlogPostTags from '@/components/blog/BlogPostTags.astro';
import BlogPostHero from '@/components/blog/BlogPostHero.astro';
import { getSortedPostsByLang, getPostNavigation, getRelatedPosts } from '@/features/blog/blogData';

type Props = CollectionEntry<'blog'>['data'] & {
  slug: string;
  readingTime?: string;
  headings: { depth: number; slug: string; text: string }[];
};

const {
  title,
  description,
  pubDate,
  editDate: updatedDate,
  heroImage,
  heroImageAlt,
  author,
  authorURL,
  tags,
  slug,
  readingTime,
  headings,
  faqs,
  review,
  license,
  acquireLicensePage,
  creditText,
  copyrightNotice,
  creator,
} = Astro.props;

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Data fetching and logic moved to features/blog/blogData.ts
const allLangPosts = await getSortedPostsByLang(lang);
const { previousPostData, nextPostData } = getPostNavigation(allLangPosts, slug, lang);
const relatedPosts = getRelatedPosts(allLangPosts, slug, tags);
---

<Layout
  title={title}
  description={description}
  image={heroImage}
  imageAlt={heroImageAlt}
  lang={lang}
  type="article"
  publishedTime={pubDate.toISOString()}
  modifiedTime={updatedDate?.toISOString()}
  author={author}
  authorUrl={authorURL}
  articleDate={pubDate}
  tags={tags || []}
  readingTime={readingTime ? parseInt(readingTime.replace(/\D/g, '')) : undefined}
  excerpt={description}
  breadcrumbs={[
    { name: t('nav.home'), url: new URL(getLocalizedPath('/', lang), Astro.site).href },
    { name: t('nav.blog'), url: new URL(getLocalizedPath('/blog', lang), Astro.site).href },
    { name: title, url: Astro.url.href },
  ]}
  organization={{
    name: SITE_TITLE,
    url: SITE_URL,
    logo: new URL('/favicon.svg', SITE_URL).href,
    sameAs: [
      'https://github.com/leonism',
      'https://twitter.com/gerryleonugroho',
      'https://linkedin.com/company/astro-batavia',
    ],
  }}
  faqs={faqs}
  review={review}
  license={license}
  acquireLicensePage={acquireLicensePage}
  creditText={creditText}
  copyrightNotice={copyrightNotice}
  creator={creator}
>
  <main id="main-content">
    <article role="article" class="mx-auto max-w-4xl px-4 py-8 sm:px-6 lg:px-8">
      <!-- Back to blog link -->
      <div class="mb-8">
        <a
          href={getLocalizedPath('/blog', lang)}
          class="inline-flex items-center text-primary-600 transition-colors duration-200 hover:text-primary-700 dark:text-primary-400 dark:hover:text-primary-300"
        >
          <svg
            class="mr-2 h-4 w-4"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            aria-hidden="true"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 19l-7-7 7-7"
            />
          </svg>
          {t('blog.back-to-blog')}
        </a>
      </div>

      <!-- Article header -->
      <header class="mb-8">
        <BlogPostHero {heroImage} {heroImageAlt} {title} />

        <BlogPostMeta
          {author}
          {pubDate}
          {updatedDate}
          {readingTime}
          {lang}
          {t}
        />

        <BlogPostTags tags={tags || []} {lang} />
      </header>

      {headings.length > 0 && <BlogTableOfContents {headings} {lang} />}

      <!-- Article content -->
      <div class="prose prose-lg max-w-none dark:prose-invert">
        <slot />
      </div>

      <!-- Footer elements -->
      <BlogShareButtons {title} url={Astro.url.href} />

      <BlogNextPrevNavigation
        {previousPostData}
        {nextPostData}
        {lang}
      />

      <BlogRelatedArticles {relatedPosts} {lang} />
    </article>
  </main>
</Layout>