export const prerender = true;
---
import { type CollectionEntry, getCollection } from 'astro:content';
import BlogPost from '@/layouts/BlogPost.astro';
import { isValidLanguage } from '@/i18n/utils';

interface PathParams {
  lang: string;
  slug: string;
}

interface StaticPath {
  params: PathParams;
  props: CollectionEntry<'blog'>;
}

export async function getStaticPaths() {
  const allPosts = await getCollection('blog', ({ id, data }: { id: string, data: any }) => id.startsWith('en/') && !data.draft);

  return allPosts.map((post: CollectionEntry<'blog'>) => {
    const parts = post.id.split('/');
    // parts[0] is 'en', parts[1] is 'blog' or the actual slug
    const slugPart = parts[1] === 'blog' ? parts.slice(2).join('/') : parts.slice(1).join('/');
    const finalSlug = slugPart.replace(/\.(mdx?)$/, '');

    return {
      params: {
        slug: finalSlug
      },
      props: post,
    };
  });
}

type Props = CollectionEntry<'blog'>;

const lang = "en";

// Validate language
if (!lang || !isValidLanguage(lang)) {
  return Astro.redirect('/404');
}

const post = Astro.props;
const { Content, headings = [] } = await post.render();
console.log('Extracted headings:', headings);
---

<BlogPost {...post.data} slug={post.slug} headings={headings}>
  <Content />
</BlogPost>
