---
import { getCollection, type CollectionEntry } from 'astro:content';
import Layout from '@/layouts/Layout.astro';
import BlogCard from '@/components/blog/BlogCard.astro';
import { useTranslations, slugifyTag } from '@/i18n/utils';
import { LOCALES, PAGINATION_POSTS_PER_PAGE } from '@/consts';

export async function getStaticPaths() {
  const allPosts = await getCollection('blog');
  const uniqueTags = [...new Set(allPosts.flatMap((post) => post.data.tags || []))];

  const allPaths = uniqueTags
    .map((tag) => ({
      params: { tag: slugifyTag(tag) },
      props: { tag },
    }))
    .filter((path) => path.params.tag.length > 0);

  // Group by slug to prevent duplicates (e.g. "AI" and "ai" both becoming "ai")
  const pathMap = new Map();
  allPaths.forEach((p) => {
    if (!pathMap.has(p.params.tag)) {
      pathMap.set(p.params.tag, p);
    }
  });

  return Array.from(pathMap.values());
}

const { tag } = Astro.props;
const lang = LOCALES.en;
const t = useTranslations(lang);

// Get blog posts for this language and tag
const posts = await getCollection('blog', ({ id, data }: CollectionEntry<'blog'>) => {
  if (!id.startsWith(`${lang}/`) || data.draft) return false;
  if (!data.tags) return false;

  // Check if any tag matches the slugified version (in case of case sensitivity or spaces)
  return data.tags.some((t) => slugifyTag(t) === Astro.params.tag);
});

// Sort posts by publication date (newest first)
const sortedPosts = posts.sort(
  (a: CollectionEntry<'blog'>, b: CollectionEntry<'blog'>) =>
    b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);

const allTags = [...new Set(posts.flatMap((post) => post.data.tags || []))].sort();

const postsPerPage = PAGINATION_POSTS_PER_PAGE;
const totalPages = Math.ceil(sortedPosts.length / postsPerPage);
// For static tag pages, we might want to show all or implement pagination.
// For now, let's behave like the main index and show first page, but with no load more for simplicity unless we add it.
// Actually, let's keep it simple and show all for tag pages or limit?
// The user asked for "populate article with similar tagging".
// Let's reuse the layout logic.
const postsToDisplay = sortedPosts.slice(0, postsPerPage);

const pageProps = {
  postsPerPage,
  totalPages,
  lang,
};
---

<Layout
  {...pageProps}
  title={`#${tag} | ${t('nav.blog')}`}
  description={`Explore articles about ${tag} on our technology and web development blog.`}
  lang={lang}
>
  <div class="mx-auto max-w-7xl px-4 py-8 sm:px-6 lg:px-8">
    <!-- Header -->
    <div class="mb-12 text-center">
      <h1 class="mb-4 text-4xl font-bold text-gray-900 dark:text-gray-100 sm:text-5xl">
        #{tag}
      </h1>
      <p class="mx-auto max-w-3xl text-xl text-gray-600 dark:text-gray-300">
        Articles tagged with #{tag}
      </p>
    </div>

    <!-- Posts Grid -->
    {
      postsToDisplay.length > 0 ? (
        <div
          id="posts-container"
          class="mb-12 grid grid-cols-1 gap-8 md:grid-cols-2 lg:grid-cols-3"
        >
          {postsToDisplay.map((post: CollectionEntry<'blog'>) => (
            <div class="post-item animate-fade-in">
              <BlogCard post={post} lang={lang} />
            </div>
          ))}
        </div>
      ) : (
        <div class="py-12 text-center">
          <p class="text-gray-500 dark:text-gray-400">No articles found.</p>
        </div>
      )
    }
  </div>
</Layout>
