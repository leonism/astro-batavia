---
/**
 * @file Unified Blog Index
 * @description Centralized blog landing page showing posts from all languages.
 * Path: /blog
 */

import { getCollection } from 'astro:content';
import Layout from '@/layouts/Layout.astro';
import BlogCard from '@/components/blog/BlogCard.astro';
import { useTranslations, isValidLanguage } from '@/i18n/utils';
import { DEFAULT_LOCALE, PAGINATION_POSTS_PER_PAGE } from '@/consts';

const langParam = Astro.url.searchParams.get('lang');
const lang = (langParam && isValidLanguage(langParam)) ? langParam : DEFAULT_LOCALE;
const t = useTranslations(lang as any);

// Fetch posts and filter by language if param is present
const allPosts = await getCollection('blog', ({ data, id }) => {
  const isPublished = import.meta.env.PROD ? !data.draft : true;
  if (langParam && isValidLanguage(langParam)) {
    return isPublished && id.startsWith(`${langParam}/`);
  }
  return isPublished;
});

// Sort by date, newest first
const sortedPosts = posts.sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

const postsPerPage = PAGINATION_POSTS_PER_PAGE;
const postsToDisplay = sortedPosts.slice(0, postsPerPage);
---

<Layout
  title={t('nav.blog')}
  description="Browse our collection of technology and AI articles in multiple languages."
  lang={lang}
>
  <div class="mx-auto max-w-7xl px-4 py-8 sm:px-6 lg:px-8">
    <div class="mb-12 text-center">
      <h1 class="mb-4 text-4xl font-bold text-gray-900 dark:text-gray-100 sm:text-5xl">
        {t('nav.blog')}
      </h1>
      <p class="mx-auto max-w-3xl text-xl text-gray-600 dark:text-gray-300">
        Discover insights and tutorials from our community.
      </p>
    </div>

    {
      postsToDisplay.length > 0 ? (
        <div
          id="posts-container"
          class="mb-12 grid grid-cols-1 gap-8 md:grid-cols-2 lg:grid-cols-3"
        >
          {postsToDisplay.map((post) => (
            <div class="post-item animate-fade-in">
              <BlogCard post={post} lang={post.id.split('/')[0] as any} />
            </div>
          ))}
        </div>
      ) : (
        <div class="py-12 text-center">
          <p class="text-gray-500 dark:text-gray-400">No articles found.</p>
        </div>
      )
    }
  </div>
</Layout>
