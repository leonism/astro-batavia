---
export const prerender = true;
import { type CollectionEntry, getCollection } from "astro:content";
import Layout from "@/layouts/Layout.astro";
import HomeHero from "@/components/home/HomeHero.astro";
import HomeLatestPosts from "@/components/home/HomeLatestPosts.astro";
import HomeNewsletter from "@/components/home/HomeNewsletter.astro";
import { useTranslations, isValidLanguage } from "@/i18n/utils";

export async function getStaticPaths() {
  return [{ params: { lang: "es" } }, { params: { lang: "ja" } }];
}

const { lang } = Astro.params;

// Validate language
if (!lang || !isValidLanguage(lang)) {
  return Astro.redirect("/404");
}

const t = useTranslations(lang);

// Get latest blog posts for this language
const allPosts = await getCollection(
  "blog",
  ({ id, data }: { id: string; data: CollectionEntry<"blog">["data"] }) => {
    return id.startsWith(`${lang}/`) && !data.draft;
  }
);

// Sort posts by publication date (newest first)
const sortedPosts = allPosts.sort(
  (a: CollectionEntry<"blog">, b: CollectionEntry<"blog">) =>
    b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);
const latestPosts = sortedPosts.slice(0, 3);
---

<Layout
  title="AstroBatavia - Modern Multi-Language Blog"
  description={t("meta.description")}
  lang={lang}>
  <HomeHero
    lang={lang}
    t={t}
  />
  <HomeLatestPosts
    latestPosts={latestPosts}
    lang={lang}
    t={t}
  />
  <HomeNewsletter
    lang={lang}
    t={t}
  />
</Layout>
