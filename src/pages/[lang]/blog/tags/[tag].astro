---
import { getCollection, type CollectionEntry } from 'astro:content';
import Layout from '@/layouts/Layout.astro';
import BlogCard from '@/components/blog/BlogCard.astro';
import { useTranslations, slugifyTag } from '@/i18n/utils';
import { ui } from '@/i18n/ui';

export async function getStaticPaths() {
  const allPosts = await getCollection('blog');
  const uniqueTags = [...new Set(allPosts.flatMap(post => post.data.tags || []))];
  const validTags = uniqueTags.filter(tag => tag && tag.trim().length > 0);
  const languages = ['es', 'ja']; // en is handled separately

  return languages.flatMap(lang =>
    validTags.map(tag => ({
      params: {
        lang,
        tag: slugifyTag(tag)
      },
      props: { tag }
    }))
  );
}

const { tag } = Astro.props;
const { lang } = Astro.params;
const t = useTranslations(lang as keyof typeof ui);

// Get blog posts for this language and tag
const posts = await getCollection('blog', ({ id, data }: CollectionEntry<'blog'>) => {
  if (!id.startsWith(`${lang}/`) || data.draft) return false;
  if (!data.tags) return false;

  return data.tags.some(t => slugifyTag(t) === Astro.params.tag);
});

// Sort posts by publication date (newest first)
const sortedPosts = posts.sort(
  (a: CollectionEntry<"blog">, b: CollectionEntry<"blog">) =>
    b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

const postsPerPage = 9;
const totalPages = Math.ceil(sortedPosts.length / postsPerPage);
const postsToDisplay = sortedPosts.slice(0, postsPerPage);

const pageProps = {
  postsPerPage,
  totalPages,
  lang,
};
---

<Layout
  {...pageProps}
  title={`#${tag} | ${t('nav.blog')} | Astro Batavia`}
  description={lang === 'es' ? `Artículos sobre ${tag}` : lang === 'ja' ? `${tag}に関する記事` : `Articles about ${tag}`}
  lang={lang}
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="text-center mb-12">
      <h1 class="text-4xl sm:text-5xl font-bold text-gray-900 dark:text-gray-100 mb-4">
        #{tag}
      </h1>
      <p class="text-xl text-gray-600 dark:text-gray-300 max-w-3xl mx-auto">
        {lang === 'es' ? `Artículos etiquetados con #${tag}` : lang === 'ja' ? `#${tag} のタグが付いた記事` : `Articles tagged with #${tag}`}
      </p>
    </div>

    <!-- Posts Grid -->
    {postsToDisplay.length > 0 ? (
      <div id="posts-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mb-12">
        {postsToDisplay.map((post: CollectionEntry<'blog'>) => (
          <div class="post-item animate-fade-in">
            <BlogCard post={post} lang={lang} />
          </div>
        ))}
      </div>
    ) : (
      <div class="text-center py-12">
        <p class="text-gray-500 dark:text-gray-400">
          {lang === 'es' ? 'No se encontraron artículos.' : lang === 'ja' ? '記事が見つかりません。' : 'No articles found.'}
        </p>
      </div>
    )}
  </div>
</Layout>
