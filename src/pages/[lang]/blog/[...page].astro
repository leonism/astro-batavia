---
import { type CollectionEntry } from 'astro:content';
import Layout from '@/layouts/Layout.astro';
import BlogPost from '@/layouts/BlogPost.astro';
import BlogCard from '@/components/blog/BlogCard.astro';
import { useTranslations, isValidLanguage } from '@/i18n/utils';
import { BlogService } from '@/services/BlogService';
import { PAGINATION_POSTS_PER_PAGE } from '@/consts';
import type { GetStaticPaths, MarkdownHeading, Page } from 'astro';

export const getStaticPaths = (async ({ paginate }) => {
  const languages = ['en', 'es', 'ja'];
  const allPaths = [];

  // 1. Pagination Paths
  for (const lang of languages) {
    const posts = await BlogService.getPostsByLang(lang);
    const paths = paginate(posts, {
      params: { lang },
      pageSize: PAGINATION_POSTS_PER_PAGE,
    });
    allPaths.push(...paths);
  }

  // 2. Individual Post Paths
  const allPosts = await BlogService.getAllPosts();
  const postPaths = allPosts.map((post) => {
    const [lang, ...slugParts] = post.slug.split('/');
    // Remove 'blog' from the slug parts if it exists to get the page param
    // post.slug is like 'en/blog/my-post' -> slugParts = ['blog', 'my-post'] -> page = 'my-post'
    const page = slugParts[0] === 'blog' ? slugParts.slice(1).join('/') : slugParts.join('/');

    return {
      params: { lang, page },
      props: { post },
    };
  });

  allPaths.push(...postPaths);

  return allPaths;
}) satisfies GetStaticPaths;

type Props = {
  post?: CollectionEntry<'blog'>;
  page?: Page<CollectionEntry<'blog'>>;
};

const { post, page } = Astro.props as Props;
const { lang } = Astro.params;

// Validate language
if (!lang || !isValidLanguage(lang)) {
  return Astro.redirect('/404');
}

// Prepare data for rendering
let Content: any;
let headings: MarkdownHeading[] = [];
let readingTime;

if (post) {
  const rendered = await post.render();
  Content = rendered.Content;
  headings = rendered.headings;
  readingTime = rendered.remarkPluginFrontmatter?.readingTime;
}

const t = useTranslations(lang);
const allTags = await BlogService.getUniqueTags(lang);

// Determine if we are on the first page
const isFirstPage = page?.currentPage === 1;
const pagePosts = page?.data || [];
---

{
  post ? (
    <BlogPost
      {...post.data}
      slug={post.slug}
      headings={headings}
      readingTime={readingTime}>
      {Content && <Content />}
    </BlogPost>
  ) : (
    <Layout
      title={`${t('nav.blog')} ${page && !isFirstPage ? `| Page ${page.currentPage}` : ''}`}
      description={
        lang === 'es'
          ? 'Explora nuestra colección de artículos sobre desarrollo web, tendencias tecnológicas y perspectivas.'
          : lang === 'ja'
            ? 'ウェブ開発、技術トレンド、洞察をカバーする記事のコレクションをご覧ください。'
            : 'Explore our collection of articles covering web development, technology trends, and insights.'
      }
      lang={lang}>
      <div class="mx-auto max-w-7xl px-4 py-8 sm:px-6 lg:px-8">
        {/* Header */}
        <div class="mb-12 text-center">
          <h1 class="mb-4 text-4xl font-bold text-gray-900 dark:text-gray-100 sm:text-5xl">
            {t('nav.blog')}
          </h1>
          <p class="mx-auto max-w-3xl text-xl text-gray-600 dark:text-gray-300">
            {lang === 'es'
              ? 'Últimas noticias, tutoriales y actualizaciones de nuestro equipo'
              : lang === 'ja'
                ? 'チームからの最新ニュース、チュートリアル、アップデート'
                : 'Latest news, tutorials, and updates from our team'}
          </p>
        </div>

        {/* Featured Post - Only on first page */}
        {isFirstPage && pagePosts.length > 0 && (
          <div class="mb-16">
            {
              <BlogCard
                post={pagePosts[0]}
                isFeatured={true}
                lang={lang}
              />
            }
          </div>
        )}

        {/* Blog Grid */}
        <div class="grid gap-8 md:grid-cols-2 lg:grid-cols-3">
          {/*
            Render posts grid.
            Optimization: We eagerly load images for the first 3 posts in the grid
            to ensure LCP (Largest Contentful Paint) is optimized for the first row,
            preventing "unoptimized loading attribute" warnings and layout shifts.
          */}
          {pagePosts.slice(isFirstPage ? 1 : 0).map((post, index) => (
            <BlogCard
              post={post}
              lang={lang}
              loading={index < 3 ? 'eager' : 'lazy'}
            />
          ))}
        </div>

        {/* Pagination */}
        {page && page.lastPage > 1 && (
          <div class="mt-12 flex justify-center">
            <nav
              class="flex items-center gap-2"
              aria-label="Pagination">
              {page.url.prev ? (
                <a
                  href={page.url.prev}
                  class="rounded-lg border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-600 dark:text-gray-300 dark:hover:bg-gray-800">
                  ← {t('blog.previousArticle')}
                </a>
              ) : (
                <span class="cursor-not-allowed rounded-lg border border-gray-200 px-4 py-2 text-sm font-medium text-gray-400 dark:border-gray-700 dark:text-gray-500">
                  ← {t('blog.previousArticle')}
                </span>
              )}

              <span class="px-4 py-2 text-sm text-gray-600 dark:text-gray-400">
                Page {page.currentPage} of {page.lastPage}
              </span>

              {page.url.next ? (
                <a
                  href={page.url.next}
                  class="rounded-lg border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-600 dark:text-gray-300 dark:hover:bg-gray-800">
                  {t('blog.nextArticle')} →
                </a>
              ) : (
                <span class="cursor-not-allowed rounded-lg border border-gray-200 px-4 py-2 text-sm font-medium text-gray-400 dark:border-gray-700 dark:text-gray-500">
                  {t('blog.nextArticle')} →
                </span>
              )}
            </nav>
          </div>
        )}
      </div>
    </Layout>
  )
}

<script>
  import { initializeBlogIndex } from '@/services/BlogIndexClient';

  function setupLoadMore() {
    // Only initialize if the button exists and hasn't been initialized
    const button = document.getElementById('load-more');
    if (!button || button.dataset.loadMoreInitialized === 'true') return;

    // Initialize our client-side logic
    initializeBlogIndex();
  }

  // Handle Astro view transitions and initial load
  document.addEventListener('astro:page-load', setupLoadMore);

  // Fallback for non-view-transition initial loads
  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    setupLoadMore();
  } else {
    document.addEventListener('DOMContentLoaded', setupLoadMore);
  }
</script>
