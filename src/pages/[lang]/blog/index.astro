---
import { type CollectionEntry } from 'astro:content';
import Layout from '@/layouts/Layout.astro';
import BlogCard from '@/components/blog/BlogCard.astro';
import { useTranslations, isValidLanguage } from '@/i18n/utils';
import { BlogService } from '@/services/BlogService';
import { PAGINATION_POSTS_PER_PAGE } from '@/consts';

export async function getStaticPaths() {
  const languages = ['en', 'es', 'ja'];

  return languages.map((lang) => ({
    params: { lang },
  }));
}

const { lang } = Astro.params;

// Validate language
if (!lang || !isValidLanguage(lang)) {
  return Astro.redirect('/404');
}

const t = useTranslations(lang);

// Get filtered and sorted blog posts for this language
const currentTag = Astro.url.searchParams.get('tag');
let posts: CollectionEntry<'blog'>[];

if (currentTag) {
  posts = await BlogService.getPostsByTag(lang, currentTag);
} else {
  posts = await BlogService.getPostsByLang(lang);
}

// Get unique tags
const allTags = await BlogService.getUniqueTags(lang);

const postsPerPage = PAGINATION_POSTS_PER_PAGE;
const totalPages = Math.ceil(posts.length / postsPerPage);
const postsToDisplay = posts.slice(0, postsPerPage);
const pageProps = {
  postsPerPage,
  totalPages,
  lang,
};
---

<Layout
  {...pageProps}
  title={`${t('nav.blog')}${currentTag ? ` | #${currentTag}` : ''}`}
  description={currentTag
    ? lang === 'es'
      ? `Explora artículos sobre ${currentTag} en nuestro blog de tecnología y desarrollo web.`
      : lang === 'ja'
        ? `${currentTag}に関する技術とウェブ開発のブログ記事をご覧ください。`
        : `Explore articles about ${currentTag} on our technology and web development blog.`
    : lang === 'es'
      ? 'Explora nuestra colección de artículos sobre desarrollo web, tendencias tecnológicas y perspectivas.'
      : lang === 'ja'
        ? 'ウェブ開発、技術トレンド、洞察をカバーする記事のコレクションをご覧ください。'
        : 'Explore our collection of articles covering web development, technology trends, and insights.'}
  lang={lang}>
  <div class="mx-auto max-w-7xl px-4 py-8 sm:px-6 lg:px-8">
    <!-- Header -->
    <div class="mb-12 text-center">
      <h1 class="mb-4 text-4xl font-bold text-gray-900 dark:text-gray-100 sm:text-5xl">
        {currentTag ? `#${currentTag}` : t('nav.blog')}
      </h1>
      <p class="mx-auto max-w-3xl text-xl text-gray-600 dark:text-gray-300">
        {
          currentTag
            ? lang === 'es'
              ? `Artículos etiquetados con #${currentTag}`
              : lang === 'ja'
                ? `#${currentTag} のタグが付いた記事`
                : `Articles tagged with #${currentTag}`
            : lang === 'es'
              ? 'Explora nuestra colección de artículos sobre desarrollo web, tendencias tecnológicas y perspectivas.'
              : lang === 'ja'
                ? 'ウェブ開発、技術トレンド、洞察をカバーする記事のコレクションをご覧ください。'
                : 'Explore our collection of articles covering web development, technology trends, and insights.'
        }
      </p>
    </div>

    <!-- Stats -->
    <div class="mb-12 flex flex-wrap justify-center gap-6">
      <div class="text-center">
        <div class="text-3xl font-bold text-primary-600 dark:text-primary-400">
          {posts.length}
        </div>
        <div class="text-sm text-gray-500 dark:text-gray-400">
          {
            lang === 'es'
              ? posts.length === 1
                ? 'Artículo'
                : 'Artículos'
              : lang === 'ja'
                ? '記事'
                : posts.length === 1
                  ? 'Article'
                  : 'Articles'
          }
          {
            currentTag &&
              (lang === 'es'
                ? ` con #${currentTag}`
                : lang === 'ja'
                  ? ` (#${currentTag})`
                  : ` with #${currentTag}`)
          }
        </div>
      </div>
      <div class="text-center">
        <div class="text-3xl font-bold text-primary-600 dark:text-primary-400">
          {allTags.length}
        </div>
        <div class="text-sm text-gray-500 dark:text-gray-400">
          {
            lang === 'es'
              ? allTags.length === 1
                ? 'Tema'
                : 'Temas'
              : lang === 'ja'
                ? 'トピック'
                : allTags.length === 1
                  ? 'Topic'
                  : 'Topics'
          }
        </div>
      </div>
    </div>

    <!-- Posts Grid -->
    {
      postsToDisplay.length > 0 ? (
        <div
          id="posts-container"
          class="mb-12 grid grid-cols-1 gap-8 md:grid-cols-2 lg:grid-cols-3">
          {postsToDisplay.map((post: CollectionEntry<'blog'>) => (
            <div class="post-item animate-fade-in">
              <BlogCard
                post={post}
                lang={lang}
              />
            </div>
          ))}
        </div>
      ) : (
        <div class="py-12 text-center">
          <svg
            class="mx-auto mb-4 h-16 w-16 text-gray-400"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
            />
          </svg>
          <h3 class="mb-2 text-lg font-medium text-gray-900 dark:text-gray-100">
            {currentTag ? t('blog.noPostsForTag').replace('{tag}', currentTag) : t('blog.no-posts')}
          </h3>
          <p class="text-gray-500 dark:text-gray-400">
            {currentTag
              ? lang === 'es'
                ? `Intenta con otra etiqueta o revisa todos los artículos.`
                : lang === 'ja'
                  ? `別のタグを試すか、すべての記事を確認してください。`
                  : `Try a different tag or check all articles.`
              : lang === 'es'
                ? '¡Vuelve pronto para nuevo contenido!'
                : lang === 'ja'
                  ? '新しいコンテンツをお楽しみに！'
                  : 'Check back soon for new content!'}
          </p>
        </div>
      )
    }

    <!-- Load More Button -->
    {
      totalPages > 1 && (
        <div class="text-center">
          <button
            id="load-more"
            class="inline-flex items-center rounded-md border border-transparent bg-primary-600 px-6 py-3 text-base font-medium text-white transition-all duration-200 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2"
            data-total-pages={totalPages}
            data-lang={lang}>
            {lang === 'es'
              ? 'Cargar Más Artículos'
              : lang === 'ja'
                ? 'もっと記事を読む'
                : 'Load More Articles'}
            <svg
              class="ml-2 h-5 w-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M19 9l-7 7-7-7"
              />
            </svg>
          </button>
        </div>
      )
    }
  </div>
</Layout>

<script
  src="/src/services/BlogIndexClient.ts"
  type="module">
</script>
